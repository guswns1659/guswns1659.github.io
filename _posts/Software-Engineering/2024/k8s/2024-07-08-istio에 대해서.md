---
title: istio에 대해서
date: 2024-07-08 11:49:08 +09:00
categories: [Software-Engineering]
tags: engineering
---

# istio 왜 쓰는가? = 서비스메쉬 왜 쓰는가? 

....

# istio 아키텍쳐 

k8s와 유사하게 컨트롤 플레인과 데이터 플레인으로 나눠진다. 

![image](https://github.com/guswns1659/guswns1659.github.io/assets/55608425/702a3633-c0db-4c68-b5c0-bd2938e0cfa2)


# deployment yaml에 istio envoy 컨테이너 spec이 없는데 envoy 컨테이너가 자동으로 생성되는 이유

Istio 사이드카 프록시(Envoy)를 파드에 자동으로 주입하는 것은 Istio의 주요 기능 중 하나입니다. 
Istio는 이를 위해 "자동 사이드카 주입(auto sidecar injection)"이라는 메커니즘을 사용합니다. 이는 Istio의 컨트롤 플레인에서 이루어지며, 
Istio의 `istio-sidecar-injector`라는 구성 요소가 이를 담당합니다. 이 기능은 파드를 생성할 때, Istio가 자동으로 사이드카 프록시 컨테이너를 파드에 추가하도록 합니다.

### 자동 사이드카 주입 메커니즘

1. **네임스페이스 라벨링**:
   - 특정 네임스페이스에 Istio 사이드카를 자동으로 주입하려면, 해당 네임스페이스에 라벨을 추가해야 합니다.
   - 예시:
     ```bash
     kubectl label namespace <namespace> istio-injection=enabled
     ```

2. **Webhook 구성**:
   - Istio는 Kubernetes의 `MutatingAdmissionWebhook` 기능을 사용하여 파드가 생성될 때 자동으로 사이드카 프록시를 주입합니다.
   - `istio-sidecar-injector`라는 MutatingAdmissionWebhook이 파드 생성 요청을 가로채고, 파드 스펙에 Envoy 사이드카 컨테이너를 추가합니다.

3. **파드 생성 시 사이드카 주입**:
   - 새로운 파드가 생성될 때, `istio-sidecar-injector`가 파드의 정의를 수정하여 Envoy 사이드카 컨테이너를 추가합니다.
   - 파드의 원래 스펙에는 Envoy 사이드카 컨테이너가 없지만, 생성되는 과정에서 자동으로 주입됩니다.


# envoy가 트래픽을 가로채는 방법

### 사이드카 패턴과 Envoy 주입

1. **사이드카 패턴**:
   - **사이드카 패턴**은 주 애플리케이션 컨테이너와 함께 보조 컨테이너(사이드카)를 실행하여, 네트워크 트래픽을 처리하고 다양한 기능을 제공합니다. Istio는 Envoy 프록시를 사이드카 컨테이너로 사용합니다.
   - Kubernetes에서 파드 정의에 사이드카 컨테이너를 명시적으로 추가하거나, Istio의 자동 주입 기능을 통해 파드 생성 시 자동으로 주입할 수 있습니다.

2. **Envoy 사이드카 자동 주입**:
   - Istio는 `istio-sidecar-injector`를 사용하여 새로운 파드가 생성될 때 Envoy 프록시를 자동으로 주입합니다. 이를 위해 네임스페이스에 `istio-injection=enabled` 라벨을 추가해야 합니다.
   - Envoy 프록시는 각 파드와 함께 배포되며, 파드의 네트워크 네임스페이스에서 트래픽을 가로챕니다.

### 트래픽 가로채기 메커니즘

1. **IP 테이블 설정**:
   - Envoy 사이드카는 iptables 규칙을 사용하여 네트워크 트래픽을 가로챕니다. iptables는 Linux 커널에서 패킷 필터링 및 네트워크 주소 변환(NAT)을 수행하는 유틸리티입니다.
   - 파드의 초기화 컨테이너(Init Container)는 iptables 규칙을 설정하여, 파드의 모든 인바운드 및 아웃바운드 트래픽이 Envoy 프록시를 경유하도록 합니다.

2. **트래픽 리디렉션**:
   - 설정된 iptables 규칙에 따라, 파드의 모든 네트워크 트래픽은 Envoy 프록시로 리디렉션됩니다.
   - Envoy 프록시는 Istio 컨트롤 플레인(주로 Pilot)에서 제공하는 라우팅 규칙과 정책을 적용하여 트래픽을 처리합니다.

### 구성 예시

#### 네임스페이스 라벨링

```bash
kubectl label namespace default istio-injection=enabled
```

#### 파드 정의 예시

파드 정의에는 Envoy 프록시가 명시되지 않지만, 파드 생성 시 자동으로 주입됩니다.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp-container
        image: myimage:latest
        ports:
        - containerPort: 8080
```

#### iptables 규칙 설정 예시

Envoy 프록시는 초기화 컨테이너를 통해 다음과 같은 iptables 규칙을 설정합니다:

```bash
# Redirect all outbound traffic to Envoy
iptables -t nat -A OUTPUT -p tcp -j REDIRECT --to-port 15001

# Redirect inbound traffic to Envoy
iptables -t nat -A PREROUTING -p tcp -j REDIRECT --to-port 15001
```
